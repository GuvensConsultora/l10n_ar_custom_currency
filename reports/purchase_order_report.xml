<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!--
        Por qué: Heredar reporte de orden de compra para imprimir en moneda compañía
        Patrón: Template Inheritance - misma lógica que ventas
    -->

    <template id="report_purchaseorder_document_inherit" inherit_id="purchase.report_purchaseorder_document">

        <!--
            Por qué: Determinar moneda a mostrar
        -->
        <xpath expr="//t[@t-set='o']" position="after">
            <t t-set="doc_currency" t-value="o.company_currency_id if o.print_in_company_currency else o.currency_id"/>
        </xpath>

        <!--
            Por qué: Precios unitarios en líneas
        -->
        <xpath expr="//span[@t-field='line.price_unit']" position="replace">
            <span t-if="o.print_in_company_currency"
                  t-field="line.price_unit_company"
                  t-options='{"widget": "monetary", "display_currency": o.company_currency_id}'/>
            <span t-else=""
                  t-field="line.price_unit"
                  t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
        </xpath>

        <!--
            Por qué: Subtotales por línea
        -->
        <xpath expr="//span[@t-field='line.price_subtotal']" position="replace">
            <span t-if="o.print_in_company_currency"
                  t-field="line.price_subtotal_company"
                  t-options='{"widget": "monetary", "display_currency": o.company_currency_id}'/>
            <span t-else=""
                  t-field="line.price_subtotal"
                  t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
        </xpath>

        <!--
            Por qué: Total del documento
        -->
        <xpath expr="//span[@t-field='o.amount_total']" position="replace">
            <span t-if="o.print_in_company_currency"
                  t-field="o.amount_total_company"
                  t-options='{"widget": "monetary", "display_currency": o.company_currency_id}'/>
            <span t-else=""
                  t-field="o.amount_total"
                  t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
        </xpath>

        <!--
            Por qué: Nota sobre moneda y tasa
        -->
        <xpath expr="//div[@id='total']" position="after">
            <div t-if="o.print_in_company_currency and o.currency_id != o.company_currency_id" class="alert alert-info mt-3">
                <strong>Nota:</strong>
                Montos expresados en
                <span t-field="o.company_currency_id.name"/>
                <span t-if="o.manual_currency_rate">
                    aplicando tasa manual de
                    <span t-field="o.manual_currency_rate"/> por <span t-field="o.currency_id.name"/>.
                </span>
                <span t-else="">
                    aplicando tasa del sistema.
                </span>
            </div>
        </xpath>

    </template>
</odoo>
